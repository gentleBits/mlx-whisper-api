name: Test Homebrew Installation

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-pip-install:
    name: Test pip install
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install package via pip
        run: pip install .

      - name: Verify CLI version
        run: mlx-whisper-api --version

      - name: Pre-download tiny model
        run: |
          python -c "from huggingface_hub import snapshot_download; snapshot_download('mlx-community/whisper-tiny-mlx')"

      - name: Start server in background
        run: |
          mlx-whisper-api --port 8080 &
          echo $! > server.pid
          sleep 5

      - name: Test health endpoint
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8080/health)
          if [ "$response" != "200" ]; then
            echo "Health check failed with status: $response"
            exit 1
          fi
          echo "Health check passed"

      - name: Test transcription with tiny model
        timeout-minutes: 5
        run: |
          response=$(curl -s -w "\n%{http_code}" -X POST http://127.0.0.1:8080/transcribe \
            -F "file=@tests/fixtures/audio/short.wav" \
            -F "model=mlx-community/whisper-tiny-mlx")
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          if [ "$http_code" != "200" ]; then
            echo "Transcription failed with status: $http_code"
            echo "Response: $body"
            exit 1
          fi
          echo "Transcription succeeded: $body"

      - name: Shutdown server
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) 2>/dev/null || true
          fi

  test-brew-install:
    name: Test brew install --HEAD
    runs-on: macos-14
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code (for test audio files)
        uses: actions/checkout@v4

      - name: Tap gentleBits/mlx-whisper-api
        run: brew tap gentleBits/mlx-whisper-api

      - name: Audit formula
        run: brew audit --strict gentleBits/mlx-whisper-api/mlx-whisper-api || true

      - name: Install from HEAD
        run: brew install --HEAD mlx-whisper-api || true
        # Note: May show pydantic_core linkage warning but install still works

      - name: Run formula test
        run: brew test mlx-whisper-api

      - name: Verify CLI version
        run: mlx-whisper-api --version

      - name: Pre-download tiny model
        run: |
          python3 -c "from huggingface_hub import snapshot_download; snapshot_download('mlx-community/whisper-tiny-mlx')"

      - name: Start server in background
        run: |
          mlx-whisper-api --port 8080 &
          echo $! > server.pid
          sleep 5

      - name: Test health endpoint
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8080/health)
          if [ "$response" != "200" ]; then
            echo "Health check failed with status: $response"
            exit 1
          fi
          echo "Health check passed"

      - name: Test transcription with tiny model
        timeout-minutes: 5
        run: |
          response=$(curl -s -w "\n%{http_code}" -X POST http://127.0.0.1:8080/transcribe \
            -F "file=@tests/fixtures/audio/short.wav" \
            -F "model=mlx-community/whisper-tiny-mlx")
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          if [ "$http_code" != "200" ]; then
            echo "Transcription failed with status: $http_code"
            echo "Response: $body"
            exit 1
          fi
          echo "Transcription succeeded: $body"

      - name: Shutdown server
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) 2>/dev/null || true
          fi
